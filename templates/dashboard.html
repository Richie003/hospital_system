{%extends 'base.html'%}
<!--  -->
{%load static%}
<!--  -->
{%block links%}
<link
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
	rel="stylesheet"
/>
<style>
	body {
		background-color: #f1f5f9;
	}
	.card {
		border: 0;
		border-radius: 0.5rem;
		box-shadow: 0 2px 4px rgba(0, 0, 20, 0.08), 0 1px 2px rgba(0, 0, 20, 0.08);
	}
	.rounded-bottom {
		border-bottom-left-radius: 0.375rem !important;
		border-bottom-right-radius: 0.375rem !important;
	}

	.avatar-xxl {
		height: 7.5rem;
		width: 7.5rem;
	}
	.nav-lt-tab {
		border-top: 1px solid var(--dashui-border-color);
	}
	.px-4 {
		padding-left: 1rem !important;
		padding-right: 1rem !important;
	}

	.avatar-sm {
		height: 2rem;
		width: 2rem;
	}

	.nav-lt-tab .nav-item {
		margin: -0.0625rem 1rem 0;
	}
	.nav-lt-tab .nav-item .nav-link {
		border-radius: 0;
		border-top: 2px solid transparent;
		color: var(--dashui-gray-600);
		font-weight: 500;
		padding: 1rem 0;
	}

	.pt-20 {
		padding-top: 8rem !important;
	}

	.avatar-xxl.avatar-indicators:before {
		bottom: 5px;
		height: 16%;
		right: 17%;
		width: 16%;
	}
	.avatar-online:before {
		background-color: #198754;
	}
	.avatar-indicators:before {
		border: 2px solid #fff;
		border-radius: 50%;
		bottom: 0;
		content: "";
		display: table;
		height: 30%;
		position: absolute;
		right: 5%;
		width: 30%;
	}

	.avatar-xxl {
		height: 7.5rem;
		width: 7.5rem;
	}
	.mt-n10 {
		margin-top: -3rem !important;
	}
	.me-2 {
		margin-right: 0.5rem !important;
	}
	.align-items-end {
		align-items: flex-end !important;
	}
	.rounded-circle {
		border-radius: 50% !important;
	}
	.border-2 {
		--dashui-border-width: 2px;
	}
	.border {
		border: 1px solid #dcdcdc !important;
	}

	.py-6 {
		padding-bottom: 1.5rem !important;
		padding-top: 1.5rem !important;
	}

	.bg-gray-300 {
		--dashui-bg-opacity: 1;
		background-color: #cbd5e1 !important;
	}

	.mb-6 {
		margin-bottom: 1.5rem !important;
	}
	.align-items-center {
		align-items: center !important;
	}

	.mb-4 {
		margin-bottom: 1rem !important;
	}

	.mb-8 {
		margin-bottom: 2rem !important;
	}
	.shadow-none {
		box-shadow: none !important;
	}

	.card > .list-group:last-child {
		border-bottom-left-radius: 0.5rem;
		border-bottom-right-radius: 0.5rem;
		border-bottom-width: 0;
	}
	.card > .list-group:first-child {
		border-top-left-radius: 0.5rem;
		border-top-right-radius: 0.5rem;
		border-top-width: 0;
	}
	.card > .list-group {
		border-bottom: inherit;
		border-top: inherit;
	}
	h6,
	h5,
	h1,
	h3,
	h4,
	h2,
	i,
	p,
	em,
	.date {
		color: #20202c !important;
	}
	.appointment-item.hovered {
		background-color: #f0f0f0; /* Example background color on hover */
		cursor: pointer; /* Change cursor to pointer on hover */
	}
</style>
{%endblock links%}
<!--  -->
{%block title%}{%endblock title%}
<!--  -->
{%block content%}
<!--  -->
{%csrf_token%}
<div class="container mt-4">
	<div class="row align-items-center">
		<div class="col-xl-12 col-lg-12 col-md-12 col-12">
			<!-- Bg -->
			<div
				class="pt-20 rounded-top"
				style="
					background: url(https://bootdey.com/image/480x480/FF00FF/000000)
						no-repeat;
					background-size: cover;
				"
			></div>
			<div class="card rounded-bottom smooth-shadow-sm">
				<div
					class="d-flex align-items-center justify-content-between pt-4 pb-6 px-4"
				>
					<!-- avatar -->
					<div class="d-flex align-items-center">
						<div
							style="background: white; border-radius: 100%"
							class="avatar-xxl avatar-indicators avatar-online me-2 position-relative d-flex justify-content-end align-items-end mt-n10"
						>
							<img
								src="{% static 'images/user.png' %}"
								class="avatar-xxl rounded-circle border border-2"
								alt="Image"
							/>
						</div>
						<!-- content -->
						<div class="lh-1">
							<h2 class="mb-0">
								Admin Dashboard
								<a href="#" class="text-decoration-none"> </a>
							</h2>
						</div>
					</div>
				</div>
				<div class="py-3"></div>
			</div>
		</div>
	</div>
	<!-- page content -->
	<div class="py-6">
		<div class="row">
			<div class="offset-lg-1 col-lg-10 col-md-12 col-12">
				<!-- row -->
				<div class="row align-items-center mb-6">
					<div class="col-lg-6 col-md-12 col-12">
						<form>
							<input
								type="search"
								class="form-control"
								placeholder="Search Your Activity"
							/>
						</form>
					</div>
					<div class="col-lg-6 col-md-12 col-12 d-flex justify-content-end">
						<div>
							<a
								href="#"
								class="btn btn-outline-light btn-ghost btn-icon btn-sm texttooltip"
								data-template="filterOne"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
									class="feather feather-filter icon-xs"
								>
									<polygon
										points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"
									></polygon>
								</svg>
								<div class="d-none" id="filterOne"><span>Filter</span></div>
							</a>
						</div>
					</div>
				</div>
				<!-- hr -->

				<div class="mb-8">
					<!-- card -->
					<div class="card bg-gray-300 shadow-none mb-4">
						<!-- card body -->
						<div class="card-body">
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<h5 class="mb-0">Unattended appointments</h5>
								</div>
								<div>
									<a href="#" class="text-muted">
										<svg
											fill="#20202c"
											height="1.5rem"
											version="1.1"
											id="Capa_1"
											xmlns="http://www.w3.org/2000/svg"
											xmlns:xlink="http://www.w3.org/1999/xlink"
											viewBox="0 0 439.814 439.814"
											xml:space="preserve"
										>
											<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
											<g
												id="SVGRepo_tracerCarrier"
												stroke-linecap="round"
												stroke-linejoin="round"
											></g>
											<g id="SVGRepo_iconCarrier">
												<g>
													<g>
														<path
															d="M166.864,91.238H272.95c16.821,0,30.457-13.636,30.457-30.457c0-16.821-13.636-30.457-30.457-30.457h-5.395 C265.158,13.19,250.451,0,232.657,0h-25.5c-17.795,0-32.501,13.189-34.898,30.324h-5.395c-16.821,0-30.457,13.636-30.457,30.457 C136.407,77.602,150.043,91.238,166.864,91.238z"
														></path>
														<path
															d="M313.407,20.814h-18.821c11.413,6.203,19.879,17.154,22.75,30.182c22.979,1.998,41.071,21.33,41.071,44.818v269 c0,24.812-20.188,45-45,45h-187c-24.813,0-45-20.188-45-45v-269c0-23.488,18.092-42.82,41.071-44.818 c2.87-13.028,11.336-23.979,22.75-30.182h-18.821c-41.355,0-75,33.645-75,75v269c0,41.354,33.645,75,75,75h187 c41.355,0,75-33.646,75-75v-269C388.407,54.459,354.763,20.814,313.407,20.814z"
														></path>
														<path
															d="M312.907,143.314h-93c-8.284,0-15,6.716-15,15c0,8.284,6.716,15,15,15h93c8.284,0,15-6.716,15-15 C327.907,150.03,321.191,143.314,312.907,143.314z"
														></path>
														<path
															d="M312.907,223.314h-93c-8.284,0-15,6.716-15,15c0,8.283,6.716,15,15,15h93c8.284,0,15-6.717,15-15 C327.907,230.03,321.191,223.314,312.907,223.314z"
														></path>
														<path
															d="M312.907,303.314h-93c-8.284,0-15,6.716-15,15c0,8.283,6.716,15,15,15h93c8.284,0,15-6.717,15-15 C327.907,310.03,321.191,303.314,312.907,303.314z"
														></path>
														<path
															d="M197.407,158.314c0-24.854-20.147-45-45.001-45c-24.853,0-45,20.146-45,45c0,17.423,9.909,32.522,24.392,40 c-14.483,7.477-24.392,22.576-24.392,40c0,17.423,9.909,32.521,24.392,40c-14.483,7.477-24.392,22.576-24.392,40 c0,24.853,20.147,45,45,45c24.854,0,45.001-20.147,45.001-45c0-17.424-9.909-32.523-24.393-40 c14.484-7.479,24.393-22.577,24.393-40c0-17.424-9.909-32.523-24.393-40C187.499,190.836,197.407,175.737,197.407,158.314z M180.139,298.631c3.307,3.308,3.307,8.67,0,11.979l-27.39,27.39c-1.654,1.653-3.82,2.479-5.989,2.479s-4.335-0.826-5.989-2.479 l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979c3.31-3.309,8.672-3.309,11.979,0l10.105,10.104l21.399-21.399 C171.467,295.322,176.829,295.322,180.139,298.631z M180.139,218.63c3.307,3.308,3.307,8.67,0,11.979l-27.39,27.39 c-1.654,1.653-3.82,2.479-5.989,2.479s-4.335-0.826-5.989-2.479l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979 c3.31-3.309,8.672-3.309,11.979,0l10.105,10.104l21.399-21.4C171.467,215.322,176.829,215.322,180.139,218.63z M180.139,150.608 l-27.39,27.39c-1.654,1.653-3.82,2.48-5.989,2.48s-4.335-0.827-5.989-2.48l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979 c3.31-3.308,8.672-3.308,11.979,0l10.105,10.105l21.399-21.4c3.307-3.308,8.67-3.308,11.979,0 C183.446,141.938,183.446,147.301,180.139,150.608z"
														></path>
													</g>
												</g>
											</g>
										</svg>
									</a>
								</div>
							</div>
						</div>
					</div>
					<!-- card -->
					<div class="card">
						<!-- list group -->
						<ul class="list-group list-group-flush" id="unchecked">
							<!-- list group item -->
						</ul>
					</div>
				</div>
				<div class="mb-8">
					<!-- card -->
					<div class="card bg-gray-300 shadow-none mb-4">
						<!-- card body -->
						<div class="card-body">
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<h5 class="mb-0">Closed appointments</h5>
								</div>
								<div>
									<a href="#" class="text-muted">
										<svg
											fill="#20202c"
											height="1.5rem"
											version="1.1"
											id="Capa_1"
											xmlns="http://www.w3.org/2000/svg"
											xmlns:xlink="http://www.w3.org/1999/xlink"
											viewBox="0 0 439.814 439.814"
											xml:space="preserve"
										>
											<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
											<g
												id="SVGRepo_tracerCarrier"
												stroke-linecap="round"
												stroke-linejoin="round"
											></g>
											<g id="SVGRepo_iconCarrier">
												<g>
													<g>
														<path
															d="M166.864,91.238H272.95c16.821,0,30.457-13.636,30.457-30.457c0-16.821-13.636-30.457-30.457-30.457h-5.395 C265.158,13.19,250.451,0,232.657,0h-25.5c-17.795,0-32.501,13.189-34.898,30.324h-5.395c-16.821,0-30.457,13.636-30.457,30.457 C136.407,77.602,150.043,91.238,166.864,91.238z"
														></path>
														<path
															d="M313.407,20.814h-18.821c11.413,6.203,19.879,17.154,22.75,30.182c22.979,1.998,41.071,21.33,41.071,44.818v269 c0,24.812-20.188,45-45,45h-187c-24.813,0-45-20.188-45-45v-269c0-23.488,18.092-42.82,41.071-44.818 c2.87-13.028,11.336-23.979,22.75-30.182h-18.821c-41.355,0-75,33.645-75,75v269c0,41.354,33.645,75,75,75h187 c41.355,0,75-33.646,75-75v-269C388.407,54.459,354.763,20.814,313.407,20.814z"
														></path>
														<path
															d="M312.907,143.314h-93c-8.284,0-15,6.716-15,15c0,8.284,6.716,15,15,15h93c8.284,0,15-6.716,15-15 C327.907,150.03,321.191,143.314,312.907,143.314z"
														></path>
														<path
															d="M312.907,223.314h-93c-8.284,0-15,6.716-15,15c0,8.283,6.716,15,15,15h93c8.284,0,15-6.717,15-15 C327.907,230.03,321.191,223.314,312.907,223.314z"
														></path>
														<path
															d="M312.907,303.314h-93c-8.284,0-15,6.716-15,15c0,8.283,6.716,15,15,15h93c8.284,0,15-6.717,15-15 C327.907,310.03,321.191,303.314,312.907,303.314z"
														></path>
														<path
															d="M197.407,158.314c0-24.854-20.147-45-45.001-45c-24.853,0-45,20.146-45,45c0,17.423,9.909,32.522,24.392,40 c-14.483,7.477-24.392,22.576-24.392,40c0,17.423,9.909,32.521,24.392,40c-14.483,7.477-24.392,22.576-24.392,40 c0,24.853,20.147,45,45,45c24.854,0,45.001-20.147,45.001-45c0-17.424-9.909-32.523-24.393-40 c14.484-7.479,24.393-22.577,24.393-40c0-17.424-9.909-32.523-24.393-40C187.499,190.836,197.407,175.737,197.407,158.314z M180.139,298.631c3.307,3.308,3.307,8.67,0,11.979l-27.39,27.39c-1.654,1.653-3.82,2.479-5.989,2.479s-4.335-0.826-5.989-2.479 l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979c3.31-3.309,8.672-3.309,11.979,0l10.105,10.104l21.399-21.399 C171.467,295.322,176.829,295.322,180.139,298.631z M180.139,218.63c3.307,3.308,3.307,8.67,0,11.979l-27.39,27.39 c-1.654,1.653-3.82,2.479-5.989,2.479s-4.335-0.826-5.989-2.479l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979 c3.31-3.309,8.672-3.309,11.979,0l10.105,10.104l21.399-21.4C171.467,215.322,176.829,215.322,180.139,218.63z M180.139,150.608 l-27.39,27.39c-1.654,1.653-3.82,2.48-5.989,2.48s-4.335-0.827-5.989-2.48l-16.096-16.095c-3.307-3.307-3.307-8.671,0-11.979 c3.31-3.308,8.672-3.308,11.979,0l10.105,10.105l21.399-21.4c3.307-3.308,8.67-3.308,11.979,0 C183.446,141.938,183.446,147.301,180.139,150.608z"
														></path>
													</g>
												</g>
											</g>
										</svg>
									</a>
								</div>
							</div>
						</div>
					</div>
					<!-- card -->
					<div class="card">
						<!-- list group -->
						<ul class="list-group list-group-flush" id="checked">
							<!-- list group item  -->
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!--  -->
<div
	class="modal fade"
	id="infoModalScrollable"
	tabindex="-1"
	aria-labelledby="infoModalScrollableTitle"
	aria-modal="true"
	role="dialog"
>
	<div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="infoModalScrollableTitle">No Title</h1>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="Close"
				></button>
			</div>
			<div class="modal-body">
				<p id="InfoModalBody">No Data</p>
				<br />
				<table class="table">
					<thead>
						<tr>
							<th scope="col">Email</th>
							<th scope="col">Tel</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td colspan="2" class="table-active" id="user-email"></td>
							<td id="phone"></td>
						</tr>
					</tbody>
				</table>
				<br />
				<br />
				<br />
				<br />
				<div>
					<p id="infoDoctor"></p>
					<span class="badge text-bg-success" id="infoDate"></span>
				</div>
			</div>
		</div>
	</div>
</div>
{%endblock content%}
<!--  -->
{%block scripts%}
<script>
	function getAppointmentById(data, id) {
		return data.appointments.find((app) => app.id === id);
	}

	$(".btn-close").click(() => {
		$(".modal").removeClass("d-block show");
	});

	const getAppointments = () => {
		$.ajax({
			type: "GET",
			url: `/api/dashboard/`,
			success: (response) => {
				const openStatus = $("#unchecked");
				const closedStatus = $("#checked");
				const userEmail = $("#user-email");
				const userTel = $("#phone");
				const infoModal = $("#infoModalScrollable");
				let trueText = "";
				let falseText = "";

				if (response && response.appointments) {
					// console.log(response.appointments);
					response.appointments.forEach((element) => {
						const appointmentItem = `
							<li class="list-group-item p-3 appointment-item">
								<div class="d-flex justify-content-between align-items-center">
									<div class="d-flex align-items-center appointment-data" data-id="${element.id}">
										<!-- img or avatar -->
										<div>
											<svg class="avatar-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#171717">
												<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
												<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
												<g id="SVGRepo_iconCarrier">
													<path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="#cd1313" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
													<path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" stroke="#cd1313" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
												</g>
											</svg>
										</div>
										<!-- content -->
										<div class="ms-3">
											<p class="mb-0 font-weight-medium">
												${element.short}
												<a>Read more</a>
											</p>
										</div>
									</div>
									<div>
										<!-- dropdown -->
										<div class="dropdown dropstart">
											<a
												href="#"
												class="btn btn-ghost btn-icon btn-sm"
												id="dropdownactivity${element.id}"
												data-bs-toggle="dropdown"
												aria-haspopup="true"
												aria-expanded="false"
											>
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="24"
													height="24"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="2"
													stroke-linecap="round"
													stroke-linejoin="round"
													class="feather feather-more-vertical icon-xs"
												>
													<circle cx="12" cy="12" r="1"></circle>
													<circle cx="12" cy="5" r="1"></circle>
													<circle cx="12" cy="19" r="1"></circle>
												</svg>
											</a>
											<div class="dropdown-menu" aria-labelledby="dropdownactivity${element.id}">
												<a class="dropdown-item d-flex align-items-center" href="#">View</a>
												<a class="dropdown-item d-flex align-items-center toggle-status" data-id="${
													element.id
												}">${element.status ? "Re-open" : "Close"}</a>
												<a class="dropdown-item d-flex align-items-center delete-btn" data-id="${
													element.id
												}">Delete</a>
											</div>
										</div>
									</div>
								</div>
							</li>
						`;

						if (element.status) {
							trueText += appointmentItem;
						} else {
							falseText += appointmentItem;
						}
					});

					openStatus.empty().append(falseText);
					closedStatus.empty().append(trueText);

					// Attach hover event handlers
					$(".appointment-data")
						.on("mouseenter", function () {
							$(this).addClass("hovered");
							infoModal.addClass("d-block show");
							let getID = $(this).attr("data-id");
							const dataBody = getAppointmentById(response, parseInt(getID));
							$("#infoModalScrollableTitle").empty().append(dataBody["short"]);
							$("#InfoModalBody").empty().append(dataBody["reason"]);
							userEmail.empty().append(dataBody["patient"]);
							userTel.empty().append(dataBody["tel"]);
							$("#infoDate").empty().append(dataBody["date"]);
							$("#infoDoctor")
								.empty()
								.append(`With ~ Dr. ${dataBody["doctor"]}`);
						})
						.on("mouseleave", function () {
							$(this).removeClass("hovered");
						});

					// Attach click event handlers for delete buttons
					$(".delete-btn").click(function () {
						const appointmentId = $(this).data("id");
						console.log(appointmentId);

						if (confirm("Are you sure you want to delete this appointment?")) {
							$.ajax({
								url: `/appointments/${appointmentId}/delete/`,
								type: "POST",
								data: {
									csrfmiddlewaretoken: $(
										"input[name=csrfmiddlewaretoken]"
									).val(),
								},
								success: function (response) {
									if (response.success) {
										alert(response.message);
										// Optionally, remove the deleted appointment from the DOM
										$(`a[data-id="${appointmentId}"]`)
											.closest(".appointment-item")
											.remove();
									} else {
										alert("Error: " + response.message);
									}
								},
								error: function () {
									alert("An error occurred while deleting the appointment.");
								},
							});
						}
					});
					$(".toggle-status").click(function (e) {
						e.preventDefault();
						const appointmentId = $(this).data("id");

						$.ajax({
							url: `/appointments/${appointmentId}/toggle-status/`,
							type: "POST",
							data: {
								csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
							},
							success: function (response) {
								if (response.success) {
									alert(response.message);
									// Optionally, update the appointment status in the DOM
									getAppointments(); // Refresh the list of appointments
								} else {
									alert("Error: " + response.message);
								}
							},
							error: function () {
								alert(
									"An error occurred while updating the appointment status."
								);
							},
						});
					});
				}
			},
			error: (xhr, status, error) => {
				console.error(`Error: ${status} - ${error}`);
			},
		});
	};

	$(document).ready(() => getAppointments());
</script>

{%endblock scripts%}
